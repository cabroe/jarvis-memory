<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Memory Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --danger: #f85149;
            --success: #3fb950;
            --warning: #d29922;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, #1a1e2e 0%, #0d1117 100%) !important;
            border-bottom: 1px solid var(--border);
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .table-container {
            background: var(--card);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .table-container h3 {
            color: var(--accent);
            font-weight: 600;
        }

        .table {
            color: var(--text);
        }

        .table thead th {
            background: #21262d !important;
            color: var(--text);
            border-bottom: 2px solid var(--border);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            border-color: var(--border);
        }

        .table tbody tr:hover {
            background: rgba(88, 166, 255, 0.05);
        }

        .table td {
            vertical-align: middle;
            border-color: var(--border);
        }

        .data-cell {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .data-cell:hover {
            white-space: normal;
            overflow: visible;
            word-break: break-all;
            background: #1c2333;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 15px rgba(88, 166, 255, 0.1);
            padding: 8px;
            border-radius: 6px;
        }

        .badge.bg-primary {
            background: #1f6feb !important;
        }

        .badge.bg-success {
            background: #238636 !important;
        }

        .confidence-bar {
            width: 60px;
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .confidence-high {
            background: var(--success);
        }

        .confidence-mid {
            background: var(--warning);
        }

        .confidence-low {
            background: var(--danger);
        }

        .btn-action {
            padding: 4px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 2px;
        }

        .btn-action:hover {
            background: #21262d;
            color: var(--text);
        }

        .btn-edit:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-delete:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-confidence:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        /* Modal styling */
        .modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .modal-header {
            border-bottom-color: var(--border);
        }

        .modal-footer {
            border-top-color: var(--border);
        }

        .modal-title {
            color: var(--accent);
        }

        .form-control,
        .form-select {
            background: #0d1117;
            border-color: var(--border);
            color: var(--text);
        }

        .form-control:focus,
        .form-select:focus {
            background: #0d1117;
            border-color: var(--accent);
            color: var(--text);
            box-shadow: 0 0 0 0.2rem rgba(88, 166, 255, 0.15);
        }

        .form-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .btn-close {
            filter: invert(1);
        }

        .btn-primary {
            background: #1f6feb;
            border-color: #1f6feb;
        }

        .btn-danger {
            background: #da3633;
            border-color: #da3633;
        }

        /* DataTables dark overrides */
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            background: #0d1117 !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_length label,
        .dataTables_wrapper .dataTables_filter label {
            color: var(--text-muted) !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: var(--text-muted) !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #1f6feb !important;
            border-color: #1f6feb !important;
            color: #fff !important;
        }

        .page-item .page-link {
            background: var(--card);
            border-color: var(--border);
            color: var(--text-muted);
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 24px;
            flex: 1;
        }

        .stat-card .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üß† Jarvis Memory Admin Panel</span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <!-- Seeds Table -->
        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h3 class="mb-3">Seeds</h3>
                    <div class="table-responsive">
                        <table id="seedsTable" class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Content</th>
                                    <th>Confidence</th>
                                    <th>Last Accessed</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .Seeds}}
                                <tr id="seed-{{.ID}}">
                                    <td><small class="text-muted">{{.ID}}</small></td>
                                    <td>{{.Title}}</td>
                                    <td><span class="badge bg-primary">{{.Type}}</span></td>
                                    <td class="data-cell" title="{{.Content}}">{{truncate .Content 120}}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-1">
                                            <div class="confidence-bar">
                                                <div class="confidence-fill {{if ge .Confidence 0.7}}confidence-high{{else if ge .Confidence 0.3}}confidence-mid{{else}}confidence-low{{end}}"
                                                    style="width: {{printf " %.0f" (mul .Confidence 100)}}%"></div>
                                            </div>
                                            <small class="text-muted">{{printf "%.0f" (mul .Confidence 100)}}%</small>
                                        </div>
                                    </td>
                                    <td><small class="text-muted">{{.LastAccessed.Format "2006-01-02 15:04"}}</small>
                                    </td>
                                    <td><small class="text-muted">{{.CreatedAt.Format "2006-01-02 15:04"}}</small></td>
                                    <td style="white-space: nowrap;">
                                        <button class="btn-action btn-edit"
                                            onclick="openEditModal('{{.ID}}', '{{.Title}}', '{{.Type}}')"
                                            title="Edit">‚úèÔ∏è</button>
                                        <button class="btn-action btn-confidence"
                                            onclick="openConfidenceModal('{{.ID}}', {{.Confidence}})"
                                            title="Confidence">‚öñÔ∏è</button>
                                        <button class="btn-action btn-delete" onclick="deleteSeed('{{.ID}}')"
                                            title="Delete">üóëÔ∏è</button>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Contexts Table -->
        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h3 class="mb-3">Agent Contexts</h3>
                    <div class="table-responsive">
                        <table id="contextsTable" class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Agent ID</th>
                                    <th>Type</th>
                                    <th>Metadata</th>
                                    <th>Summary</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .AgentContexts}}
                                <tr>
                                    <td><small class="text-muted">{{.ID}}</small></td>
                                    <td>{{.AgentID}}</td>
                                    <td><span class="badge bg-success">{{.Type}}</span></td>
                                    <td class="data-cell" title="{{printf " %s" .Metadata}}">{{if .Metadata}}{{truncate
                                        (printf "%s" .Metadata) 120}}{{else}}N/A{{end}}</td>
                                    <td>{{if .Summary}}{{.Summary}}{{else}}N/A{{end}}</td>
                                    <td><small class="text-muted">{{.CreatedAt.Format "2006-01-02 15:04"}}</small></td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Seed Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è Edit Seed</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="editTitle">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="editType">
                            <option value="markdown">markdown</option>
                            <option value="text">text</option>
                            <option value="json">json</option>
                            <option value="auto_capture">auto_capture</option>
                            <option value="episodic">episodic</option>
                            <option value="semantic">semantic</option>
                            <option value="procedural">procedural</option>
                            <option value="working">working</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea class="form-control" id="editContent" rows="6"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSeed()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confidence Modal -->
    <div class="modal fade" id="confidenceModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚öñÔ∏è Set Confidence</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="confId">
                    <div class="mb-3">
                        <label class="form-label">Confidence (0.0 ‚Äì 1.0)</label>
                        <input type="range" class="form-range" min="0" max="1" step="0.05" id="confSlider"
                            oninput="document.getElementById('confValue').textContent = parseFloat(this.value).toFixed(2)">
                        <div class="text-center mt-2">
                            <span id="confValue"
                                style="font-size: 1.2rem; font-weight: 700; color: var(--accent);">1.00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveConfidence()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast for notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
        <div id="toast" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toastBody"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#seedsTable').DataTable({
                "order": [[6, "desc"]],
                "pageLength": 15,
                "columnDefs": [{ "orderable": false, "targets": 7 }]
            });
            $('#contextsTable').DataTable({
                "order": [[5, "desc"]],
                "pageLength": 15
            });
        });

        function showToast(msg, isError) {
            var t = document.getElementById('toast');
            t.className = 'toast align-items-center border-0 text-bg-' + (isError ? 'danger' : 'success');
            document.getElementById('toastBody').textContent = msg;
            new bootstrap.Toast(t, { delay: 3000 }).show();
        }

        function deleteSeed(id) {
            if (!confirm('Are you sure you want to delete this seed?\n\nThis action cannot be undone.')) return;

            fetch('/seeds/' + id, { method: 'DELETE' })
                .then(function (r) {
                    if (!r.ok) throw new Error('Delete failed');
                    return r.json();
                })
                .then(function () {
                    var row = document.getElementById('seed-' + id);
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(function () { row.remove(); }, 300);
                    }
                    showToast('Seed deleted successfully', false);
                })
                .catch(function (e) { showToast('Failed to delete: ' + e.message, true); });
        }

        function openEditModal(id, title, type) {
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = title;
            document.getElementById('editType').value = type;

            // Fetch the full content from the row's data-cell title attribute
            var row = document.getElementById('seed-' + id);
            var contentCell = row ? row.querySelector('.data-cell') : null;
            document.getElementById('editContent').value = contentCell ? contentCell.getAttribute('title') : '';

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        function saveSeed() {
            var id = document.getElementById('editId').value;
            var data = {
                content: document.getElementById('editContent').value,
                title: document.getElementById('editTitle').value,
                type: document.getElementById('editType').value
            };

            fetch('/seeds/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(function (r) {
                    if (!r.ok) throw new Error('Update failed');
                    return r.json();
                })
                .then(function () {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    showToast('Seed updated successfully. Refreshing...', false);
                    setTimeout(function () { location.reload(); }, 1000);
                })
                .catch(function (e) { showToast('Failed to update: ' + e.message, true); });
        }

        function openConfidenceModal(id, currentConfidence) {
            document.getElementById('confId').value = id;
            document.getElementById('confSlider').value = currentConfidence;
            document.getElementById('confValue').textContent = parseFloat(currentConfidence).toFixed(2);
            new bootstrap.Modal(document.getElementById('confidenceModal')).show();
        }

        function saveConfidence() {
            var id = document.getElementById('confId').value;
            var confidence = parseFloat(document.getElementById('confSlider').value);

            fetch('/seeds/' + id + '/confidence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confidence: confidence })
            })
                .then(function (r) {
                    if (!r.ok) throw new Error('Update failed');
                    return r.json();
                })
                .then(function () {
                    bootstrap.Modal.getInstance(document.getElementById('confidenceModal')).hide();
                    showToast('Confidence updated. Refreshing...', false);
                    setTimeout(function () { location.reload(); }, 1000);
                })
                .catch(function (e) { showToast('Failed to update confidence: ' + e.message, true); });
        }
    </script>
</body>

</html>